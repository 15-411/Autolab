<script>

  var submitClicked = false

  // I'm relying on the fact that onclick is processed before onsubmit
  function setSubmitClicked() {
      submitClicked = true
  }

  function validateIntegrity(clickedElement) {

    var temp = submitClicked
    submitClicked = false

    if (temp) {
        var checkBoxValue = document.forms["submissionForm"]["integrity_checkbox"].checked
        if (!checkBoxValue) {
            displayErrorMessage("You must agree to the academic integrity policy.")
            return false
        } else {
            return true
        }
    }

    return true
  }

  function clearErrorMessage() {
      document.getElementById("submission_error").innerHTML = "";
  }

  function displayErrorMessage(message) {
      document.getElementById("submission_error").innerHTML = message;
      window.setTimeout(clearErrorMessage, 1400);
  }

</script>

<div id="<%= id %>" data-cansubmit="<%= @can_submit %> " class="card-action">
  <% if @can_submit %> 
    <% if @assessment.max_submissions != -1 %>
      <p>You have <%= @left_count %> <%= (@left_count == 1) ? "submission" : "submissions" %> left.</p>
    <% end %>

    <% if @aud.past_due_at? %>
      <p><b>Warning:</b> It is past the due date for this assessment. Submitting now might result in the usage of a grace day or a grade penalty!</p>
    <% end %>

    <div class="row">
      <div>
        <% if @assessment.has_svn then %>
          <%= form_for @submission, url: {action: :handin}, :html => {:name => "submissionForm", :onclick => "return validateIntegrity();"}, method: :post do |f| %>

            <!-- Academic integrity checkbox -->
            <%= check_box_tag(:integrity_checkbox) %>
            <%= label_tag(:integrity_checkbox, "I affirm that I have complied with this course's academic integrity policy as defined in the syllabus.") %>

            <% if @aud.past_due_at? then %>
              <table style = "width:100%">
                <td><%= f.submit("Checkout Repository", class: "btn primary", data: { confirm: "Are you sure you want to submit late?" }, onclick: "setSubmitClicked()") %></td>
                <td id = "submission_error" style = "color:red"></td>
              </table>
            <% else %>
              <table style = "width:100%">
                <td><%= f.submit("Checkout Repository", class: "btn primary", onclick: "setSubmitClicked()") %></td>
                <td id = "submission_error" style = "color:red"></td>
              </table>
            <% end %>
          <% end %>
        <% elsif ! @assessment.disable_handins? then %>
          <%= form_for @submission, url: {action: :handin}, :html => {:name => "submissionForm", :onclick => "return validateIntegrity();"}, multipart: true do |f| %>

            <!-- Academic integrity checkbox -->
            <%= check_box_tag(:integrity_checkbox) %>
            <%= label_tag(:integrity_checkbox, "I affirm that I have complied with this course's academic integrity policy as defined in the syllabus.") %>

            <%= f.file_field :file %>
            <% if @aud.past_due_at? then %>
              <table style = "width:100%">
                <td><%= f.submit("Submit Late", id:"fake-submit",  class: "btn primary handin-btn", onclick: "setSubmitClicked()") %></td>
                <td id = "submission_error" style = "color:red"></td>
              </table>

            <% else %>
              <table style = "width:100%">
                <td><%= f.submit("Submit", id:"fake-submit", class: "btn primary handin-btn", onclick: "setSubmitClicked()") %></td>
                <td id = "submission_error" style = "color:red"></td>
              </table>
            <% end %>
          <% end %>
        <% end %>
      </div>
    </div>
	  
  <% else %>
    <% case @why_not
       when :user_dropped %>
      <h3>You cannot submit because you have dropped the course.</h3>

    <% when :before_start_at %>
      <h3>We are not yet accepting submissions for this assessment.</h3>

    <% when :past_end_at %>
      <h3>We are no longer accepting submissions for this assessment.</h3>

    <% when :at_submission_limit %>
      <h3>You have reached the maximum number of submissions allowed for this assessment.</h3>

    <% else %>
      <h3>You are not allowed to submit this assessment.</h3>

    <% end %>
  <% end %>
</div>