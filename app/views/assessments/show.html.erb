<% content_for :javascripts do %>
  <%= javascript_include_tag "assessments_show" %>
  <%= javascript_include_tag 'validateIntegrity.js' %>
<% end %>

<%# Make sure these options are not on the general user options list.  %>
<%# We have to do this because we exposed the internal interface for building options lists %>
<%# and some users have fiddled with this in their assessment.rb file %>

<%# These options have been eliminated %>
<% @list.delete("listAdmin") %>

<%# These options should only be on the admin list %>
<% @list.delete("edit") %>
<% @list.delete("viewGradesheet") %>
<% @list.delete("attachments") %>
<% @list.delete("extension") %>
<% @list.delete("submission") %>
<% @list.delete("reload") %>

<div class="">
<div class="row">
  <div class="col s12 m12">
    <h2 class="">
      <%= @assessment.display_name %>
    </h2>
    <p style="margin-left: 5px"><i><%= @assessment.description %></i></p>
  </div>
</div>
<hr>
<div class="row">
  <div class="col s12 m4">
    <%# Display any optional instructor admin options %>
    <% if @cud.instructor? then %>
      <ul class="collapsible" data-collapsible="accordion">
        <li>
          <div class="collapsible-header"><i class="material-icons"></i><h5>Admin Options</h5></div>
          <div class="collapsible-body">
            <ul class="options">
              <li> <%= link_to "Edit assessment", {:action => "edit" }, {:title=> "View and modify the properties for this assessment, including its problems", :class=>""} %></li>
              <li> <%= link_to "Grade submissions", {:action => "viewGradesheet" }, {:title=> "View and enter grades on the gradesheet" } %></li>
              <li> <%= link_to "Export assessment", {:action => "export" }, {:title=> "Export persistent properties that will be imported when you install this assessment in a future term" } %></li>

              <% if @assessment.has_autograder? then %>
                <li><%= link_to "Autograder settings", [:edit, @course, @assessment, :autograder], title: "Modify autograding properties such as the VM image and the timeout value" %></li>
              <% end %>

              <% if @assessment.has_groups? %>
                <li><%= link_to "Group settings", [@course, @assessment, :groups], title: "Manage group settings" %></li>
              <% end %>

              <% if @assessment.has_scoreboard? %>
                <li><%= link_to "Scoreboard settings", [:edit, @course, @assessment, :scoreboard], title: "Configure the appearance of the scoreboard" %></li>
              <% end %>
              <li> <%= link_to "Manage extensions", [@course, @assessment, :extensions], { title: "Give extensions to students" } %></li>
              <li> <%= link_to "Manage submissions", [@course, @assessment, :submissions], { title: "Create, view, export, and re-autograde submissions" } %></li>
              <li> <%= link_to "View statistics", {:action => "statistics" }, {:title=> "View detailed stats for this assessment" } %></li>
              <li> <%= link_to "Bulk import grades", {:action => "bulkGrade" }, {:title=> "Upload scores or feedback for multiple students from a CSV file" } %></li>
              <li> <%= link_to "Bulk export grades", {:action => "bulkExport" }, {:title=> "Export grades (with sub-scores) \nfor all students to a CSV file" } %></li>

              <li class="collection-item red-text danger-bottom no-hover"><h4>Danger Zone</h4></li>

              <li class="danger-side">
                <%= link_to "Release all grades", {:action => "releaseAllGrades" }, {:title=>  "Make all scores for this assessment visible to students", :class=>"", data: {confirm: "Are you sure you want to release all grades?"}} %>
                </li>
              <li class="danger-side"> <%= link_to "Withdraw all grades", {:action => "withdrawAllGrades" }, {:title=>  "Hide all scores for this assessment from students", data: {confirm: "Are you sure you want to withdraw all grades?"}} %></li>
              <li class="danger-side danger-bottom"> <%= link_to "Reload config file", {:action => "reload" }, {:title=> "Reload the assessment config file (provided for backward compatibility with legacy assessments)", data: {confirm: "Are you sure you want to reload the config file?"}} %></li>
            </ul>
          </div>
        </li>
      </ul>
    <% end %>

    <%# Display the optional CA admin options %>
    <% if @cud.course_assistant? or @cud.instructor? then %>
      <ul class="collapsible" data-collapsible="accordion">
        <li>
          <div class="collapsible-header"><i class="material-icons"></i><h5>CA Options</h5></div>
          <div class="collapsible-body">
            <ul class="options">
              <li><%= link_to "Grade section #{@cud.section} submissions", url_for(:action => 'viewGradesheet', :section => '1', :escape => false),
                :title=> "View and enter grades for your section. Make sure your instructor has assigned you to a section in your Notolab account" %></li>
              <li><%= link_to "Grade all submissions", url_for(:action => 'viewGradesheet'),
                :title=> "View and enter grades for all sections"  %></li>

              <% if !@assessment.disable_handins %>
                <li><%= link_to  "Download section #{@cud.section} submissions", [:downloadAll, @course, @assessment, :submissions, final: true], title: "Download section #{@cud.section} submissions" %></li>
              <% end %>
              <li class="collection-item red-text danger-bottom no-hover"><h4>Danger Zone</h4></li>
              <li class="danger-side"><%= link_to "Reload config file", url_for(:action => 'reload'),
                :title=> "Reload the assessment configuration file (provided for backward compatibility with legacy assessments)", data: {confirm: "Are you sure you want to reload the config file?"} %></li>
              <li class="danger-side danger-bottom"><%= link_to "Release section grades", url_for(:action => 'releaseSectionGrades'),
                :title=> "Make all scores visible to the students in your section. This will work only if your instructor has assigned you to a lecture and section in your Notolab account.", data: {confirm: "Are you sure you want to release section grades?"} %></li>


            </ul>
          </div>
        </li>
      </ul>
    <% end %>

    <ul class="collapsible" data-collapsible="accordion">
      <li>
        <div class="collapsible-header active"><i class="material-icons"></i><h5>Options</h5></div>
        <div class="collapsible-body">
          <ul class="options">
            <li> <%= link_to "View handin history", {:action => 'history'}, {:title=> "View your submissions, scores, and feedback from the course staff" } %> </li>
            <li> <%= link_to "View writeup", {:action => 'writeup'}, {:title=> "View the assessment writeup", :class=>""}%> </li>
            <li> <%= link_to "Download handout", {:action => 'handout'}, {:title=> "Download handout materials and starter code" } %> </li>
            <% if @assessment.has_groups? %>
              <% if @aud.membership_status != AssessmentUserDatum::UNCONFIRMED then %>
                <li><%= link_to "Group options", [@course, @assessment, @aud.group], title: "Check your group settings." %></li>
              <% else %>
                <li><%= link_to "Group options", [:new, @course, @assessment, :group], title: "Check your group settings." %></li>
              <% end %>
            <% end %>
            <% if @assessment.has_scoreboard? %>
                <li><%= link_to "View scoreboard", [@course, @assessment, :scoreboard], title: "View the assessment scoreboard" %></li>
            <% end %>

          <% @list.sort { |a,b| a[1] <=> b[1] }.each { |key, value| %>
            <% if value.size > 0  then  %>
              <li> <%= link_to value, {:action => key}, {:title=>(@list_title[key] || "")} %> </li>
            <% end %>
          <% } %>
          </ul>
        </div>
      </li>
      </ul>

  </div>
  <div class="col s12 m8">
    <br>
    <br>
    <div class="handin-panel card z-depth-0">
      <div class="card-content">
        <p class="valign-wrapper">
          <i class="material-icons valign">access_time</i>
            &nbsp;&nbsp;Due<% if @extension then %>&nbsp;(with <%=@extension.days %> day extension)<% end %>:&nbsp;
            <b><span class="moment-date-time" data-format="MMMM Do YYYY, h:mm a"> <%= due_at_display @aud.due_at %></span></b>
        </p>

        <p class="valign-wrapper">
          <i class="valign material-icons">today</i>&nbsp;&nbsp;Last day to hand in:&nbsp;&nbsp;<b><span class="moment-date-time" data-format="MMMM Do YYYY, h:mm a"> <%= end_at_display(@aud.end_at false) %></span></b>

        </p>
        <p class="valign-wrapper"><i class="material-icons valign">school</i>&nbsp;&nbsp;Grading strategy:&nbsp;&nbsp;<b>
          <%= @assessment.grade_latest ? "Latest submission" : "Maximum-scoring submission" %></b></p>
        <p class="valign-wrapper"><i class="material-icons valign">timer</i>&nbsp;&nbsp;Total running time:&nbsp;&nbsp;<b>
          <%= @aud.budget_used_string %></b></p>

        <% if @cud.instructor? and @assessment.exam? %>
        <p class="attention">This is an exam. While it is in progress, please check Admin > Edit Course > Exam In Progress.</p>
        <% end %>
      </div>
      <%= render partial: "handin_form", locals: {modal: false, id: "handin_show_assessment"} %>
      <% if @assessment.embedded_quiz %>
          <script>
              var urlArgs = {};
              if (location.search) location.search.substr(1).split("&").forEach(function(item) {
                  var kvp = item.split("=");
                  var k = kvp[0];
                  var v = kvp[1] && decodeURIComponent(kvp[1]);
                  urlArgs[k] = urlArgs[k] || [];
                  urlArgs[k].push(v);
              });

              $(function() {
                  for (var k in urlArgs) {
                      var v = urlArgs[k];
                      var elem = document.getElementsByName(k)[0]
                      // Then it's a dropdown.
                      if (elem.children.length > 0) {
                          // First, get correct element.
                          for (var j = 0; j < elem.children.length; j++) {
                              if (elem.children[j].value == v) {
                                  // Then, update the string value of dropdown
                                  var p = elem.parentElement;
                                  var dropdown = p.getElementsByClassName("select-dropdown")[0];
                                  dropdown.value = elem.children[j].text;
                                  elem.value = v;
                                  break;
                              }
                          }
                      } else {
                          elem.value = v;
                      }
                  }
              });

              $.fn.serializeObject = function()
              {
                  var o = {};
                  var a = this.serializeArray();
                  $.each(a, function() {
                      if (this.name == 'submission[embedded_quiz_form_answer]') {
                          // Avoid exponential blowup in encoding if you repeatedly hit back...
                          return;
                      }
                      if (o[this.name] !== undefined) {
                          if (!o[this.name].push) {
                              o[this.name] = [o[this.name]];
                          }
                          o[this.name].push(this.value || '');
                      } else {
                          o[this.name] = this.value || '';
                      }
                  });
                  return o;
              };

              $(function() {
                  $('form').submit(function() {
                      $('#results').text(JSON.stringify($('#quiz_form').serializeObject()));
                      showForm();
                      //return false;
                  });
              });

              function showForm() {
                  var save = document.getElementById('results').innerHTML;
                  console.log(save);
                  document.getElementById("submission_embedded_quiz_form_answer").value = save;
              }

          </script>

          <% if @can_submit %>
          <div class = "row card-action" style="border-top: 0px; margin-top: 0px; padding-top: 0px;">
            <div class = "col">
              <%= form_for @submission, url: {action: :handin}, :html => {:id => "quiz_form", :onclick => "return validateIntegrity();"}, method: :post do |f| %>

                  <%= f.hidden_field :embedded_quiz_form_answer, value: "" %>

                  <%# Render instructor's custom quiz form elements. %>
                  <p>
                    <% begin %>
                        <%= @assessment.embedded_quiz_form_data.html_safe %>
                    <% rescue %>
                      <p style = "color: red">Your assessment has no content yet! </p>
                    <% end %>
                  </p>

                  <!-- Academic integrity checkbox -->
                  <%= check_box_tag(:integrity_checkbox) %>
                  <%= label_tag(:integrity_checkbox, "I affirm that I have complied with this course's academic integrity policy as defined in the syllabus.") %>

                  <div class = "row" style = "padding-top: 10px">
                    <div id="submission_error" class="col s6 m8 center-align" style = "color: red"></div>
                    <% if @aud.past_due_at? then %>
                        <div class="col s6 m4 center-align"><%= f.submit("Submit Late", id:"fake-submit",  class: "btn primary handin-btn", onclick: "setSubmitClicked()") %></div>
                    <% else %>
                        <div class="col s6 m4 center-align"><%= f.submit("Submit", id:"fake-submit", class: "btn primary handin-btn", onclick: "setSubmitClicked()") %></div>
                    <% end %>
                  </div>
                  <div class="row">
                    <% if @assessment.max_submissions != -1 then %>
                      <% numSubmissions = @submissions.size %>
                      <% if numSubmissions > @assessment.max_submissions then %>
                        <% numSubmissions = 0 %>
                      <% else %>
                        <% numSubmissions = @assessment.max_submissions - numSubmissions %>
                      <% end %>
                      <div class="smallText col s6 offset-s6 m4 offset-m8 center-align" style="padding-top: 6px">&nbsp;&nbsp;(<%= numSubmissions %> submissions left)</div>
                    <% else %>
                      <div class="smallText col s6 offset-s6 m4 offset-m8 center-align" style="padding-top: 6px">(&nbsp;&#x221e;&nbsp;&nbsp;submissions left)</div>
                    <% end %>
                  </div>

              <% end %>
            </div>
          </div>
          <% end %>
        <% end %>

    </div>
  </div>
</div>
<% download_access = (@cud.instructor?) %>

  <%# Display any attachments %>
  <% if @assessment.attachments.length > 0 or @cud.instructor? %>
    <h2>Handouts</h2>
    <ul class="collection with-header attachments">
      <%= render @assessment.attachments %>

      <% # this code is temporarily "commented out" because Dan wants to preserve the logic for future changes to _attachment.html.erb %>
      <% if false then %>
        <% for a in @assessment.attachments do %>
          <% if a.released? then %>
            <% if (Time.now() > @assessment.start_at) or (@cud.instructor?) then %>
              <li><%= link_to a.name, [@course, @assessment, a] %></li>
            <% else %>
              <li><%= a.name %></li>
            <% end %>
          <% elsif @cud.instructor? then %>
            <li><i><%= link_to a.name, [@course, @assessment, a] %>*</i></li>
          <% end %>
        <% end %>
      <% end %>
    <% if @cud.instructor? then %>
      <li class="collection-item add">
        <%= link_to new_course_assessment_attachment_path(@course, @assessment) do %>
          <i class="material-icons left">note_add</i>Add Attachment
        <% end %>
        <span class="secondary-content"></span>
      </li>
    <% end %>
    </ul>
    <hr>

  <% end %>

  <pre class="hide" id="results"></pre>

  <% if @assessment.exam? %>
      <% if download_access %>
          <p>Students will not be able to view previous exam submissions.</p>
      <% else %>
          <p>You cannot view previous exam submissions.</p>
      <% end %>
  <% elsif @assessment.course.exam_in_progress? %>
      <% if download_access %>
          <p>Students will not be able to view previous submissions while an exam is in progress.</p>
      <% else %>
          <p>You cannot view previous submissions while an exam is in progress.</p>
      <% end %>
  <% end %>

    <% if @submissions.size == 0 then %>
      No Submissions yet!
    <% else %>
      <% for submission in @submissions.first(limit=3) do %>
        <%= render partial: "submission_summary_row",
          locals: { submission: submission,
          download_access: download_access } %>
      <% end %>
      <%= link_to "See all submissions", {:action => "history"} %></li>

    <% end %>
  </div>
