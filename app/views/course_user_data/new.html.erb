<% content_for :javascripts do %>
  <script type="application/javascript">
    $("#course_user_datum_user_attributes_email").on('change', userLookup);
    $("#course_user_datum_user_attributes_email").on('input', userLookup);
    /**
     * this AJAX function does an LDAP lookup on the partially-entered user email.
     **/
    function userLookup() {
      var email_input = document.getElementById("course_user_datum_user_attributes_email").value;
      if (!email_input || email_input == "") return;
      $.get('<%= url_for [:userLookup, @course, remote: true]  %>',  { email: email_input }, function( data ) {
        if (!data)  {
          $('#course_user_datum_user_attributes_first_name').prop('disabled', false);
          $('#course_user_datum_user_attributes_last_name').prop('disabled', false);
          // $('#course_user_datum_user_attributes_first_name').focus();
          $('#course_user_datum_user_attributes_first_name').val("");
            $('#course_user_datum_user_attributes_last_name').val("");
          return;
        }
        else {
          $('#course_user_datum_user_attributes_first_name').val(data.first_name);
          $('#course_user_datum_user_attributes_first_name').prop('disabled', true);
          $('#course_user_datum_user_attributes_last_name').val(data.last_name);
          $('#course_user_datum_user_attributes_last_name').prop('disabled', true);
          // $('#course_user_datum_nickname').focus();
        }
      });
    }
  </script>
<% end %>

<% @title="Enroll User" %>

<h2>Enroll User in <%= @course.display_name %></h2>

<br>

<%= form_for @newCUD, url: course_course_user_data_path, builder: FormBuilderWithDateTimeInput do |f| %>

<% if @newCUD.errors.any? %>
	<div id="error_explanation">
		<h2><%= pluralize(@newCUD.errors.count, "error") %>
      prohibited the data from being saved:</h2>

		<ul>
			<% @newCUD.errors.full_messages.each do |msg| %>
			<li><%= msg %></li>
			<% end %>
		</ul>
	</div>
<% end %>

  <%= f.fields_for :user, @newCUD.user do |u| %>
    <%= u.email_field :email, help_text: "User's email address. Fill this out first - autopopulates other fields.", placeholder: "johndoe@example.com" %>

    <%= u.text_field :first_name, placeholder: "John" %>
    <%= u.text_field :last_name, placeholder: "Doe" %>

  <% end %>

  <%= f.text_field :nickname, help_text: "Anonymizing nickname to display on the public scoreboards", placeholder: "batman" %>

  <%= isDisabled = false
      if !@cud.instructor? then
        isDisabled = true
      end
        f.text_field :lecture, help_text: "The lecture number", placeholder: "15213", disabled: isDisabled %>

  <%= isDisabled = false
      if !@cud.instructor? then
        isDisabled = true
      end
        f.text_field :lecture, help_text: "A course assistant can see the gradebook and bulk-release grades for their assigned lecture and section.", placeholder: "C", disabled: isDisabled %>

  <% if @cud.instructor? then %>

  <tr>
    <th>Course average tweak:</th>
    <td>
    <%= f.fields_for :tweak, @newCUD.tweak do |t| %>
      <%= t.text_field :value, size: 18, value: "0"%>
      <%= t.select :kind, options_for_select({"points" => "points", "%" => "percent"}, :selected => (@newCUD.tweak ? @newCUD.tweak.kind : "points")) %>
    <% end %>
    </td>
    <td class="smallText">A tweak is a positive or negative value that adjusts the student's course average.<br>Ex: A tweak of 5 points would increase the student's course average by 5 points. </td>
  </tr>

	<%= f.check_box :dropped, help_text: "Dropping a student from a course prevents them from handing in submissions or downloading assessments. Additionally they do not appear in any gradebook. None of their account information or submissions are deleted." %>
  
  <%= f.check_box :instructor, help_text: "Instructors have full read/write access to the course." %>

  <%= f.check_box :course_assistant, help_text: "Course assistants can assign scores to problems and nothing else." %>

  <% end %>

  <br>
  <input id="user_submit" class="btn primary"name="commit" type="submit" value="Save Changes" onclick="formvalidation(this.parentNode); return false;">

<% end %>
